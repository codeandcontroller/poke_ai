<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pokémon Card Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v='7') }}">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f9fafb; color:#333; }
    h1 { text-align:center; }
    form { text-align:center; margin:16px auto 24px; }
    form input, form select, form button { padding:8px 10px; margin:6px; border-radius:6px; border:1px solid #d1d5db; }
    form button { background:#10b981; color:#fff; border:none; cursor:pointer; }
    form button:hover { background:#0ea371; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:12px; max-width:1200px; margin:0 auto; }
    .card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.06); text-align:center; }
    .card img { width:100%; height:auto; border-radius:6px; }
    .muted { color:#6b7280; font-size:0.9rem; }
    .price { margin-top:8px; line-height:1.4; }
    .error { max-width:900px; margin:0 auto 16px; padding:10px 12px; border-radius:8px; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
    .search-meta { text-align:center; margin-bottom:16px; color:#6b7280; }
    .pager { text-align:center; margin:20px 0; }
    .pager form { display:inline; }
    .ai-box { margin-top:8px; text-align:left; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:8px; padding:10px; }
    .ai-title { font-weight:bold; margin-bottom:6px; }
  </style>
</head>
<body>
  <h1>Pokémon Card Search</h1>

  {% if error %}
    <div class="error"><strong>Heads up:</strong> {{ error }}</div>
  {% endif %}

  {% set rarities = ["Common","Uncommon","Rare","Rare Holo","Ultra Rare"] %}
  {% set types = ["Fire","Water","Grass","Electric","Psychic","Fighting","Darkness","Metal","Fairy","Dragon","Colorless"] %}

  {% set name_val = name|default(request.form.get('name','')) %}
  {% set set_val = set_name|default(request.form.get('set_name','')) %}
  {% set num_val = number|default(request.form.get('number','')) %}
  {% set rarity_val = rarity|default(request.form.get('rarity','')) %}
  {% set type_val = type_|default(request.form.get('type','')) %}
  {% set page_val = page|default(1) %}

  <form method="POST">
    <input type="text" name="name" placeholder="Card name (e.g., Pikachu)" value="{{ name_val }}">
    <input type="text" name="set_name" placeholder="Set name (e.g., Base Set)" value="{{ set_val }}">
    <input type="text" name="number" placeholder="Card number (e.g., 4)" value="{{ num_val }}">

    <select name="rarity">
      <option value="">Any Rarity</option>
      {% for r in rarities %}
        <option value="{{ r }}" {% if rarity_val==r %}selected{% endif %}>{{ r }}</option>
      {% endfor %}
    </select>

    <select name="type">
      <option value="">Any Type</option>
      {% for t in types %}
        <option value="{{ t }}" {% if type_val==t %}selected{% endif %}>{{ t }}</option>
      {% endfor %}
    </select>

    <button type="submit">Search</button>
  </form>

  {% if results is defined %}
    <div class="search-meta">
      {% if name_val or set_val or num_val or rarity_val or type_val %}
        Showing results
        {% if name_val %}for <em>{{ name_val }}</em>{% endif %}
        {% if set_val %} in set <em>{{ set_val }}</em>{% endif %}
        {% if num_val %} (card #{{ num_val }}){% endif %}
        {% if rarity_val %} — Rarity: <em>{{ rarity_val }}</em>{% endif %}
        {% if type_val %} — Type: <em>{{ type_val }}</em>{% endif %}
      {% else %}
        Showing results for all cards
      {% endif %}
      — Page {{ page_val }}
    </div>
  {% endif %}

  {% if results %}
    <div class="grid">
      {% for card in results %}
        <div class="card">
          <h2>{{ card.name }}</h2>
          <p class="muted">
            <b>Set:</b> {{ card.set.name }} &nbsp;•&nbsp;
            <b>No.:</b> {{ card.number }} &nbsp;•&nbsp;
            <b>Rarity:</b> {{ card.rarity or "N/A" }}
          </p>

          <img src="{{ card.images.small }}" alt="{{ card.name }}">

          {% set p = card._price %}
          {% if p %}
            <p class="price">
              <b>TCGplayer ({{ p.variant }})</b><br>
              Market: {{ (('$' + ('%.2f'|format(p.market))) if p.market is not none else '—') }}
              &nbsp;| Mid: {{ (('$' + ('%.2f'|format(p.mid))) if p.mid is not none else '—') }}<br>
              <span class="muted">
                Low: {{ (('$' + ('%.2f'|format(p.low))) if p.low is not none else '—') }}
                &nbsp;| High: {{ (('$' + ('%.2f'|format(p.high))) if p.high is not none else '—') }}
                {% if p.updatedAt %} • Updated {{ p.updatedAt }}{% endif %}
              </span>
            </p>
          {% else %}
            <p class="muted">No TCGplayer price found.</p>
          {% endif %}

          <!-- Ask AI button -->
          <form method="POST" action="/analyze" style="margin-top:8px;">
            <!-- carry current filters & page so we return to same results -->
            <input type="hidden" name="page" value="{{ page_val }}">
            <input type="hidden" name="name" value="{{ name_val }}">
            <input type="hidden" name="set_name" value="{{ set_val }}">
            <input type="hidden" name="number" value="{{ num_val }}">
            <input type="hidden" name="rarity" value="{{ rarity_val }}">
            <input type="hidden" name="type" value="{{ type_val }}">

            <!-- card payload for AI -->
            <input type="hidden" name="card_id" value="{{ card.id }}">
            <input type="hidden" name="card_name" value="{{ card.name }}">
            <input type="hidden" name="card_set" value="{{ card.set.name }}">
            <input type="hidden" name="card_number" value="{{ card.number }}">
            <input type="hidden" name="card_rarity" value="{{ card.rarity }}">
            <input type="hidden" name="price_variant" value="{{ p.variant if p else '' }}">
            <input type="hidden" name="price_market" value="{{ p.market if p and p.market is not none else '' }}">
            <input type="hidden" name="price_mid" value="{{ p.mid if p and p.mid is not none else '' }}">
            <input type="hidden" name="price_low" value="{{ p.low if p and p.low is not none else '' }}">
            <input type="hidden" name="price_high" value="{{ p.high if p and p.high is not none else '' }}">
            <input type="hidden" name="price_updated" value="{{ p.updatedAt if p else '' }}">

            <button type="submit">Ask AI about value</button>
          </form>

          {% if ai_opinions and ai_opinions.get(card.id) %}
            <div class="ai-box">
              <div class="ai-title">AI outlook (collector focus)</div>
              <div>{{ ai_opinions.get(card.id) }}</div>
              <div class="muted" style="margin-top:6px;">This is not financial advice.</div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="pager">
      {% if page_val|int > 1 %}
        <form method="get">
          <input type="hidden" name="from_nav" value="1">
          <input type="hidden" name="name" value="{{ name_val }}">
          <input type="hidden" name="set_name" value="{{ set_val }}">
          <input type="hidden" name="number" value="{{ num_val }}">
          <input type="hidden" name="rarity" value="{{ rarity_val }}">
          <input type="hidden" name="type" value="{{ type_val }}">
          <input type="hidden" name="page" value="{{ page_val|int - 1 }}">
          <button type="submit">Previous</button>
        </form>
      {% endif %}

      <form method="get">
        <input type="hidden" name="from_nav" value="1">
        <input type="hidden" name="name" value="{{ name_val }}">
        <input type="hidden" name="set_name" value="{{ set_val }}">
        <input type="hidden" name="number" value="{{ num_val }}">
        <input type="hidden" name="rarity" value="{{ rarity_val }}">
        <input type="hidden" name="type" value="{{ type_val }}">
        <input type="hidden" name="page" value="{{ page_val|int + 1 }}">
        <button type="submit">Next</button>
      </form>
    </div>
  {% elif results is defined %}
    <p style="text-align:center;">No cards found.</p>
  {% endif %}
</body>
</html>
